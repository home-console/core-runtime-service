# Анализ проблем управления устройствами

**Дата:** 2026-01-16  
**Цель:** Документ для обсуждения масштаба проблем и планирования решений

---

## 1. Отсутствие метаданных о состоянии устройства

### Проблема 1.1: Статус онлайн/оффлайн не сохраняется

**Текущее состояние:**
- Модель устройства (`modules/devices/services.py`) содержит только:
  - `id`, `name`, `type`
  - `state: { desired, reported, pending }`
  - Опционально: `owner_id`, `shared_with`
- **Нет поля для статуса подключения** (online/offline)
- **Нет механизма определения** доступности устройства

**Где это критично:**
- UI не может показать, доступно ли устройство
- Невозможно отличить "устройство выключено" от "устройство недоступно"
- Нет индикации проблем с подключением

**Масштаб изменений:**
- **Backend:** Добавить поле `online: bool` и `last_seen: float` в модель устройства
- **Backend:** Логика определения онлайн-статуса (heartbeat, timeout, проверка через API)
- **Backend:** Обновление статуса при получении событий `external.device_state_reported`
- **Frontend:** Отображение индикатора онлайн/оффлайн
- **API:** Типы TypeScript для новых полей

**Сложность:** Средняя  
**Зависимости:** Требует определения стратегии heartbeat/timeout

---

### Проблема 1.2: Отсутствие timestamp последнего обновления

**Текущее состояние:**
- Модель устройства **не содержит** `updated_at` или `last_updated`
- Frontend не может показать, когда устройство последний раз обновлялось
- Невозможно отсортировать устройства по времени обновления

**Где это критично:**
- UI не показывает актуальность данных
- Невозможно определить "застрявшие" устройства
- Нет истории изменений состояния

**Масштаб изменений:**
- **Backend:** Добавить `created_at: float` и `updated_at: float` в модель устройства
- **Backend:** Обновлять `updated_at` при каждом изменении состояния
- **Backend:** Миграция существующих устройств (установить `updated_at = created_at = now()`)
- **Frontend:** Отображение времени последнего обновления
- **API:** Типы TypeScript для новых полей

**Сложность:** Низкая  
**Зависимости:** Нет

---

## 2. Проблемы UI/UX на фронтенде

### Проблема 2.1: Отсутствие сортировки устройств

**Текущее состояние:**
- `DevicesPage.tsx` отображает устройства в порядке получения с API
- Нет сортировки по:
  - Имени (алфавит)
  - Типу устройства
  - Статусу (ON/OFF)
  - Времени последнего обновления
  - Онлайн/оффлайн статусу

**Где это критично:**
- При большом количестве устройств сложно найти нужное
- Нет логики группировки (по типу, по комнате, по статусу)

**Масштаб изменений:**
- **Frontend:** Добавить состояние для сортировки (поле, направление)
- **Frontend:** UI элементы для выбора сортировки (dropdown, кнопки)
- **Frontend:** Функция сортировки массива устройств
- **Frontend:** Сохранение предпочтений сортировки (localStorage)

**Сложность:** Низкая  
**Зависимости:** Требует решения проблемы 1.2 (timestamp) для сортировки по времени

---

### Проблема 2.2: Вертикальная компоновка (все в столбик)

**Текущее состояние:**
- `DevicesPage.tsx` использует `display: 'grid'` с `gap: '12px'`
- Каждое устройство занимает всю ширину
- Нет адаптивной сетки (grid columns)

**Где это критично:**
- Неэффективное использование пространства экрана
- При большом количестве устройств требуется много скролла

**Масштаб изменений:**
- **Frontend:** Изменить grid на адаптивную сетку (например, `gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))'`)
- **Frontend:** Адаптивность для мобильных устройств
- **Frontend:** Возможно, добавить компактный/расширенный вид

**Сложность:** Очень низкая  
**Зависимости:** Нет

---

## 3. Интеграция с Yandex API: отсутствие домов/комнат

### Проблема 3.1: Не загружаются дома с Яндекса

**Текущее состояние:**
- Плагин `yandex_smart_home` использует endpoint `/v1.0/user/info`
- Этот endpoint возвращает только **устройства**, но не **дома** (homes) и **комнаты** (rooms)
- В модели устройства нет полей `home_id`, `room_id`, `location`

**Анализ Yandex API:**
- Yandex Smart Home API имеет концепцию:
  - **Homes** (дома) — верхний уровень организации
  - **Rooms** (комнаты) — внутри домов
  - **Devices** (устройства) — принадлежат комнатам
- Текущий endpoint `/v1.0/user/info` возвращает плоский список устройств
- Для получения структуры домов/комнат нужен другой endpoint или дополнительный запрос

**Где это критично:**
- Невозможно организовать устройства по комнатам
- Невозможно показать иерархию: Дом → Комната → Устройство
- Нет контекста расположения устройства

**Масштаб изменений:**
- **Backend:** Исследование Yandex API для получения структуры домов/комнат
- **Backend:** Добавить модель `Home` и `Room` (или расширить модель устройства)
- **Backend:** Расширить `yandex.sync_devices` для загрузки домов/комнат
- **Backend:** Сохранение структуры домов/комнат в storage
- **Backend:** API endpoints для получения домов/комнат
- **Frontend:** UI для отображения иерархии домов/комнат
- **Frontend:** Фильтрация устройств по дому/комнате
- **API:** Типы TypeScript для домов/комнат

**Сложность:** Высокая  
**Зависимости:** 
- Требует исследования Yandex API документации
- Возможно, нужны дополнительные OAuth scopes
- Может потребоваться изменение архитектуры хранения

**Неопределенности:**
- Какой именно endpoint Yandex API возвращает дома/комнаты?
- Нужны ли дополнительные права доступа?
- Как связать устройства с комнатами (через `room_id` в ответе API)?

---

## 4. Сводная таблица проблем

| Проблема | Критичность | Сложность | Масштаб изменений | Зависимости |
|----------|-------------|-----------|-------------------|-------------|
| Онлайн/оффлайн статус | Высокая | Средняя | Backend + Frontend | Стратегия heartbeat |
| Timestamp обновления | Средняя | Низкая | Backend + Frontend | Нет |
| Сортировка устройств | Средняя | Низкая | Frontend | Требует timestamp |
| Адаптивная сетка | Низкая | Очень низкая | Frontend | Нет |
| Дома/комнаты Yandex | Высокая | Высокая | Backend + Frontend | Исследование API |

---

## 5. Рекомендуемый порядок решения

### Фаза 1: Быстрые улучшения (1-2 дня)
1. ✅ Добавить `updated_at` в модель устройства
2. ✅ Обновлять `updated_at` при изменении состояния
3. ✅ Добавить сортировку на фронтенде (по имени, типу, статусу)
4. ✅ Исправить grid layout (адаптивная сетка)

### Фаза 2: Статус устройства (3-5 дней)
1. ✅ Добавить `online: bool` и `last_seen: float` в модель
2. ✅ Логика определения онлайн-статуса
3. ✅ Обновление статуса при событиях
4. ✅ UI индикаторы онлайн/оффлайн

### Фаза 3: Интеграция домов/комнат (5-10 дней)
1. ✅ Исследование Yandex API для домов/комнат
2. ✅ Проектирование модели данных
3. ✅ Реализация загрузки структуры
4. ✅ UI для иерархии домов/комнат

---

## 6. Вопросы для обсуждения

1. **Стратегия определения онлайн-статуса:**
   - Heartbeat интервал?
   - Timeout для определения оффлайн?
   - Проверка через API при каждом обновлении?

2. **Модель домов/комнат:**
   - Отдельные сущности `Home` и `Room`?
   - Или расширить модель `Device` полями `home_id`, `room_id`?
   - Как обрабатывать устройства без комнаты?

3. **Приоритеты:**
   - Что критичнее: онлайн-статус или дома/комнаты?
   - Нужна ли сортировка сразу или можно отложить?

4. **Миграция данных:**
   - Как обработать существующие устройства без `updated_at`?
   - Нужна ли обратная совместимость?

---

## 7. Технические детали

### Текущая модель устройства (Backend)

```python
device = {
    "id": str,
    "name": str,
    "type": str,
    "state": {
        "desired": dict,
        "reported": dict,
        "pending": bool
    },
    # Опционально:
    "owner_id": str,
    "shared_with": list[str]
}
```

### Предлагаемая модель устройства

```python
device = {
    "id": str,
    "name": str,
    "type": str,
    "state": {
        "desired": dict,
        "reported": dict,
        "pending": bool
    },
    # Новые поля:
    "created_at": float,  # timestamp
    "updated_at": float,  # timestamp
    "online": bool,  # статус подключения
    "last_seen": float,  # timestamp последнего контакта
    # Для Yandex интеграции:
    "home_id": Optional[str],
    "room_id": Optional[str],
    "location": Optional[str],  # свободный текст
    # Существующие опциональные:
    "owner_id": Optional[str],
    "shared_with": Optional[list[str]]
}
```

### Текущая модель устройства (Frontend TypeScript)

```typescript
interface Device {
  id: string;
  name?: string;
  type: string;
  state: {
    desired?: { on: boolean };
    reported?: { on: boolean };
    pending?: boolean;
  };
}
```

### Предлагаемая модель устройства (Frontend TypeScript)

```typescript
interface Device {
  id: string;
  name?: string;
  type: string;
  state: {
    desired?: { on: boolean };
    reported?: { on: boolean };
    pending?: boolean;
  };
  // Новые поля:
  created_at?: number;  // timestamp
  updated_at?: number;  // timestamp
  online?: boolean;
  last_seen?: number;  // timestamp
  // Для Yandex:
  home_id?: string;
  room_id?: string;
  location?: string;
}
```

---

## 8. Оценка трудозатрат

| Задача | Оценка (часы) |
|--------|---------------|
| Добавление `updated_at` | 2-3 |
| Сортировка на фронте | 3-4 |
| Адаптивная сетка | 1-2 |
| Онлайн-статус (backend) | 8-12 |
| Онлайн-статус (frontend) | 4-6 |
| Исследование Yandex API домов | 4-8 |
| Реализация домов/комнат | 16-24 |
| **ИТОГО (без домов/комнат)** | **18-27 часов** |
| **ИТОГО (с домами/комнатами)** | **38-59 часов** |

---

**Примечание:** Этот документ создан для обсуждения масштаба проблем и планирования решений. Не содержит конкретных инструкций по реализации.
