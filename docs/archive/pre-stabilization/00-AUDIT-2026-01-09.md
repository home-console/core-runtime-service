# Аудит документации — 9 января 2026

## Диагноз: критические проблемы

### 1. Раздвоение источника истины (P0)

**Проблема:** Три документа описывают архитектуру с разных точек зрения без чёткой иерархии:
- `docs/ARCHITECTURE.md` — инварианты и контракты (canonical)
- `/ARCHITECTURE_STABILIZATION.md` — transitional отчёт о рефакторинге
- `docs/OVERVIEW.md` — обзор для новичков

**Конфликт:** Неясно, какой документ является источником истины. `ARCHITECTURE_STABILIZATION.md` содержит актуальную информацию о storage→state_engine, но находится вне docs/.

**Следствие:** При изменении архитектуры придётся синхронизировать 3+ файла вручную → неизбежная рассинхронизация.

**Решение:** 
- Объединить ARCHITECTURE.md + ARCHITECTURE_STABILIZATION.md → `docs/01-ARCHITECTURE.md` (canonical)
- OVERVIEW.md → `docs/00-README.md` (entry point для новичков)
- Удалить /ARCHITECTURE_STABILIZATION.md после слияния

---

### 2. Отсутствие разделения modules vs plugins (P0)

**Проблема:** После рефакторинга devices стал built-in модулем, но документация не отражает это разделение.

**Где проблема:**
- `docs/ARCHITECTURE.md` не объясняет различие между modules/ и plugins/
- Нет migration guide для maintainers (как перевести плагин в модуль)
- `docs/INDEX.md` ссылается на devices как на плагин

**Следствие:** Разработчики не понимают, когда использовать module, а когда plugin. Архитектурное решение не задокументировано → риск неверных архитектурных выборов.

**Решение:**
- Создать `docs/02-MODULES-AND-PLUGINS.md` (canonical):
  - Когда domain логика должна быть module (обязательная, стабильная)
  - Когда integration/UI должна быть plugin (опциональная, изолированная)
  - Migration guide: plugin → module
  - Backward compatibility strategy (shim pattern)

---

### 3. Yandex-документы доминируют в навигации (P1)

**Проблема:** 6 документов о Yandex интеграции:
- `YANDEX_REAL_INTEGRATION.md`
- `YANDEX_BEST_PRACTICES.md`
- `YANDEX_CODE_EXAMPLES.md`
- `plugins/YANDEX_REAL_README.md`
- `plugins/STUB_VS_REAL.md`
- `/YANDEX_REAL_IMPLEMENTATION.md`

**Конфликт:** Integration-специфичная документация занимает 40% docs/ и создаёт ложное впечатление, что система — это "Yandex умный дом".

**Следствие:** Новые разработчики думают, что Core привязан к Yandex. Архитектурные принципы теряются в vendor-specific деталях.

**Решение:**
- Создать `docs/05-integrations/yandex/README.md` и перенести туда все Yandex документы
- В корневом INDEX оставить только одну ссылку "Пример интеграции: Yandex"
- Добавить generic integration guide: "Как интегрировать vendor API"

---

### 4. Дублирование entry points (P1)

**Проблема:** 4 файла претендуют на роль "начни здесь":
- `docs/README.md` — основная документация (297 строк)
- `docs/INDEX.md` — навигация (253 строки)
- `docs/QUICKSTART.md` — быстрый старт
- `/DOCUMENTATION_INDEX.md` — дубликат для Yandex

**Конфликт:** Неясно, куда идти новичку. README.md философский, INDEX.md навигационный, QUICKSTART практический.

**Решение:**
- `docs/00-README.md` — единственный entry point (200 строк):
  - "Что это?" (2 параграфа)
  - "Для кого?" (разработчики, архитекторы, maintainers)
  - "Как читать документацию?" (навигация по секциям)
- `docs/01-QUICKSTART.md` — runnable шаги (100 строк)
- Удалить `/DOCUMENTATION_INDEX.md` (yandex-specific)

---

### 5. Смешение stable и transitional контента (P0)

**Проблема:** Документы не маркируют статус информации:
- Какие контракты stable?
- Какие решения transitional?
- Что экспериментально?

**Следствие:** Невозможно понять, на что можно полагаться. Разработчики боятся менять код, потому что неясны границы стабильности.

**Решение:**
В каждом каноническом документе добавить секцию:
```markdown
## Статус этого документа

- **Версия:** 0.2.0
- **Статус:** Stable | Transitional | Experimental
- **Последнее изменение:** 2026-01-09
- **Следующий ревью:** 2026-02-01
```

---

### 6. Отсутствие contracts registry (P1)

**Проблема:** События и сервисы разбросаны по коду. Нет единого реестра контрактов.

**Где искать:**
- `devices.*` сервисы — в devices_plugin
- `internal.*` события — нигде не задокументированы
- `external.*` события — упоминаются в примерах

**Следствие:** Разработчик плагина не знает, какие контракты доступны. Нарушение DRY: контракты живут только в коде.

**Решение:**
- Создать `docs/06-CONTRACTS.md`:
  - Таблица всех сервисов: имя, signature, plugin-owner, status
  - Таблица всех событий: имя, payload schema, semantics, status
  - Автогенерация из кода (опционально)

---

### 7. Несуществующий CORE_RUNTIME_CONTRACT.md (P2)

**Проблема:** `docs/CORE_RUNTIME_CONTRACT.md` существует, но содержит только негативные гарантии.

**Отсутствует:**
- Lifecycle гарантии (что Core делает при shutdown?)
- Error handling (что происходит при exception в plugin?)
- Threading model (asyncio event loop гарантии)
- Performance характеристики (latency, throughput)

**Решение:**
Дополнить CORE_RUNTIME_CONTRACT.md позитивными гарантиями и operational semantics.

---

## Предлагаемая каноническая структура

```
core-runtime-service/docs/
├── 00-README.md                    ← единственный entry point
├── 01-ARCHITECTURE.md              ← source of truth (инварианты, контракты)
├── 02-MODULES-AND-PLUGINS.md       ← когда module vs plugin
├── 03-QUICKSTART.md                ← runnable шаги (5 минут)
├── 04-CORE-RUNTIME-CONTRACT.md     ← гарантии, semantics, limitations
├── 05-DEVELOPER-GUIDE.md           ← структура кода, правила разработки
├── 06-CONTRACTS.md                 ← реестр сервисов и событий
├── 07-OPERATIONS.md                ← как запускать, env, deploy
├── 08-TESTING.md                   ← как запускать тесты, smoke scripts
├── 99-TODO.md                      ← roadmap
│
├── integrations/                   ← vendor-specific guides
│   └── yandex/
│       ├── README.md
│       ├── STUB-VS-REAL.md
│       └── examples/
│
└── archive/                        ← transitional/historical
    ├── ARCHITECTURE_STABILIZATION.md
    └── IMPLEMENTATION_COMPLETE.md
```

---

## Приоритеты выполнения

### Этап 1 (сегодня): Создать источники истины
- [ ] Создать `00-README.md` (entry point, 150 строк)
- [ ] Объединить ARCHITECTURE.md + STABILIZATION → `01-ARCHITECTURE.md`
- [ ] Создать `02-MODULES-AND-PLUGINS.md` с migration guide
- [ ] Обновить `03-QUICKSTART.md` (актуализировать шаги)

### Этап 2 (завтра): Реорганизация
- [ ] Переместить Yandex в `integrations/yandex/`
- [ ] Создать `06-CONTRACTS.md` (ручной реестр)
- [ ] Дополнить `04-CORE-RUNTIME-CONTRACT.md`

### Этап 3 (на неделе): Стабилизация
- [ ] Добавить статус в каждый документ
- [ ] Создать CHANGELOG.md
- [ ] Настроить mkdocs

---

## Что стало яснее после аудита

1. **Архитектура задокументирована неполно:** есть описание компонентов, но нет чёткого объяснения boundaries и responsibilities.
2. **Transitional состояние не маркировано:** рефакторинги (storage→state, devices→module) не отражены в docs.
3. **Yandex доминирует в навигации:** создаёт ложное впечатление о назначении системы.

## Где остаётся неопределённость

1. **Remote plugins:** `REMOTE_PLUGIN_CONTRACT.md` описывает идею, но непонятен статус — это plan или implemented?
2. **HTTP contracts:** HttpRegistry упоминается в ARCHITECTURE, но нет примеров использования и best practices.
3. **Security model:** OAuth токены, secrets — как хранить? Как rotировать? Документация молчит.

---

## Следующий шаг

Создать `00-README.md` как entry point и `01-ARCHITECTURE.md` как canonical source of truth.
