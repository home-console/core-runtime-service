# –ê–Ω–∞–ª–∏–∑ —Å—Ö–µ–º—ã Storage: namespace pattern

## –¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞

**–û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `storage` —Å namespace pattern:**
```sql
CREATE TABLE storage (
    namespace TEXT NOT NULL,
    key TEXT NOT NULL,
    value TEXT NOT NULL,  -- JSON
    PRIMARY KEY (namespace, key)
);
```

**–≠—Ç–æ –ù–ï "–º–µ—à–∞–Ω–∏–Ω–∞" ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω!** 

Namespace pattern –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –º–Ω–æ–≥–∏—Ö —É—Å–ø–µ—à–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö:
- **Redis** ‚Äî —Ä–∞–∑–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (SELECT 0, SELECT 1...)
- **DynamoDB** ‚Äî —Ç–∞–±–ª–∏—Ü—ã –∫–∞–∫ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã
- **MongoDB** ‚Äî –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π –ë–î
- **AWS S3** ‚Äî buckets (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã)
- **etcd/Consul** ‚Äî –ø—Ä–µ—Ñ–∏–∫—Å—ã –∫–ª—é—á–µ–π (`/devices/`, `/config/`)

**Namespace = –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –æ–¥–Ω–æ–π —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ**

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ namespaces

–ò–∑ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞:

1. **`devices`** - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{id, name, type, state: {desired, reported, pending}}`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —á–∞—Å—Ç–æ–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å

2. **`devices_external`** - –≤–Ω–µ—à–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Yandex, etc)
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{provider, external_id, name, type, capabilities, state}`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —á—Ç–µ–Ω–∏–µ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

3. **`devices_mappings`** - –º–∞–ø–ø–∏–Ω–≥–∏ external_id ‚Üí internal_id
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{internal_id: "..."}`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —á–∞—Å—Ç–æ–µ —á—Ç–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏–π

4. **`presence`** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `true/false` (boolean)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —Ä–µ–¥–∫–æ–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å

5. **`yandex`** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Yandex
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{use_real_api: bool, tokens: {...}, config: {...}}`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —Ä–µ–¥–∫–æ–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å

## –ü–æ—á–µ–º—É namespace pattern ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è

### ‚úÖ **–õ–æ–≥–∏—á–µ—Å–∫–∞—è –∏–∑–æ–ª—è—Ü–∏—è –±–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è**

Namespace —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã":
- `devices` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å—É—â–Ω–æ—Å—Ç—å
- `devices_mappings` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å—É—â–Ω–æ—Å—Ç—å
- `presence` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å—É—â–Ω–æ—Å—Ç—å

–ù–æ –≤—Å–µ –≤ –æ–¥–Ω–æ–π —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ ‚Äî —ç—Ç–æ **–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ**, –∞ –Ω–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫!

### ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ**

- **–û–¥–∏–Ω API** –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **–ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤
- **–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å** –Ω–æ–≤—ã–µ namespaces –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã
- **–ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** —É–ø—Ä–æ—â–∞–µ—Ç –∫–æ–¥

### ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**

- –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å **–ª—é–±—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON** –≤ –∫–∞–∂–¥–æ–º namespace
- –ù–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—Ö–µ–º—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª–µ–π
- –†–∞–∑–Ω—ã–µ namespaces –º–æ–≥—É—Ç –∏–º–µ—Ç—å **—Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è **–±—ã—Å—Ç—Ä–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å**

- –û–¥–∏–Ω –∞–¥–∞–ø—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
- –õ–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É SQLite/PostgreSQL
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –ë–î –¥–ª—è —Ä–∞–∑–Ω—ã—Ö namespaces –≤ –±—É–¥—É—â–µ–º

### ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**

- –ú–æ–∂–Ω–æ –ª–µ–≥–∫–æ **—à–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ namespace**
- –ú–æ–∂–Ω–æ **–ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å namespace** –≤ —Ä–∞–∑–Ω—ã–µ –ë–î
- –ú–æ–∂–Ω–æ **–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ namespace** –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ú–æ–∂–Ω–æ **–æ—á–∏—â–∞—Ç—å namespace** –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π

### ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

- –ò–Ω–¥–µ–∫—Å `(namespace, key)` —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–ø—Ä–æ—Å—ã –ø–æ namespace –±—ã—Å—Ç—Ä—ã–µ (WHERE namespace = ?)
- –ù–µ—Ç JOIN'–æ–≤ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∏ –±—ã—Å—Ç—Ä–æ

## –ö–æ–≥–¥–∞ namespace pattern –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º

–≠—Ç–∏ "–º–∏–Ω—É—Å—ã" –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ **–Ω–µ –º–∏–Ω—É—Å—ã**, –∞ –ø—Ä–æ—Å—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞. –û–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–æ–π —Ç–æ–ª—å–∫–æ –≤ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞—è—Ö:

### ‚ö†Ô∏è **–ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É JSON** (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω—ã)

- –ó–∞–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "–Ω–∞–π—Ç–∏ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å `state.desired.on = true`" —Ç—Ä–µ–±—É—é—Ç –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è namespace
- **–†–µ—à–µ–Ω–∏–µ:** –í PostgreSQL –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GIN –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ JSONB (—Å–º. –Ω–∏–∂–µ)
- **–î–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è:** –ù–µ –ø—Ä–æ–±–ª–µ–º–∞, —Ç.–∫. –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –ø–æ `(namespace, key)`

### ‚ö†Ô∏è **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î** (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)

- –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–†–µ—à–µ–Ω–∏–µ:** –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ –∫–æ–¥–µ (—É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å)
- **–î–ª—è PostgreSQL:** JSONB –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç JSON

### ‚ö†Ô∏è **–°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É namespaces** (—Ä–µ–¥–∫–æ –Ω—É–∂–Ω–æ)

- JOIN'—ã –º–µ–∂–¥—É namespaces –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã –Ω–∞–ø—Ä—è–º—É—é
- **–†–µ—à–µ–Ω–∏–µ:** –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–¥ –∏ —Å–¥–µ–ª–∞—Ç—å JOIN —Ç–∞–º (–¥–ª—è –≤–∞—à–∏—Ö –æ–±—ä–µ–º–æ–≤ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–∏—Ö —Å–ª—É—á–∞–µ–≤

### ‚ö†Ô∏è **–ê–≥—Ä–µ–≥–∞—Ü–∏–∏** (—Ä–µ–¥–∫–æ –Ω—É–∂–Ω–æ)

- –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç—å
- **–†–µ—à–µ–Ω–∏–µ:** –î–ª—è –≤–∞—à–∏—Ö –æ–±—ä–µ–º–æ–≤ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- **–î–ª—è PostgreSQL:** –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ JSONB –ø—Ä—è–º–æ –≤ SQL

## –ö–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å—Ö–µ–º—É?

### ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å, –µ—Å–ª–∏:

1. **–ù—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**
   ```sql
   -- –ù–∞–π—Ç–∏ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å pending=true –∏ desired.on=true
   SELECT * FROM devices 
   WHERE state->>'pending' = 'true' 
   AND state->'desired'->>'on' = 'true'
   ```

2. **–ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö**
   - >100K –∑–∞–ø–∏—Å–µ–π –≤ –æ–¥–Ω–æ–º namespace
   - –ù—É–∂–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

3. **–ù—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î**
   - CHECK constraints
   - Foreign keys –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
   - NOT NULL –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª—è—Ö

4. **–ù—É–∂–Ω—ã JOIN'—ã**
   ```sql
   SELECT d.*, m.external_id 
   FROM devices d
   JOIN device_mappings m ON d.id = m.internal_id
   ```

5. **–ù—É–∂–Ω—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏**
   ```sql
   SELECT type, COUNT(*) 
   FROM devices 
   GROUP BY type
   ```

### ‚ùå –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å, –µ—Å–ª–∏:

1. **–ü—Ä–æ—Å—Ç–æ–µ key-value –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**
   - –¢–µ–∫—É—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω: `get(namespace, key)` / `set(namespace, key, value)`
   - –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –Ω—É–∂–¥

2. **–ì–∏–±–∫–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - –ß–∞—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
   - –ù—É–∂–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

3. **–ú–∞–ª–µ–Ω—å–∫–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö**
   - <10K –∑–∞–ø–∏—Å–µ–π –Ω–∞ namespace
   - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞

## –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ JSON (PostgreSQL)

–û—Å—Ç–∞–≤–∏—Ç—å –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É, –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:

```sql
-- –î–ª—è PostgreSQL —Å JSONB
CREATE TABLE storage (
    namespace TEXT NOT NULL,
    key TEXT NOT NULL,
    value JSONB NOT NULL,  -- JSONB –≤–º–µ—Å—Ç–æ TEXT
    PRIMARY KEY (namespace, key)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_devices_state ON storage 
    USING GIN ((value->'state')) 
    WHERE namespace = 'devices';

CREATE INDEX idx_devices_type ON storage 
    (namespace, (value->>'type')) 
    WHERE namespace = 'devices';
```

**–ü–ª—é—Å—ã:**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ—Ç–∞ API
- –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø–æ JSON

**–ú–∏–Ω—É—Å—ã:**
- –¢–æ–ª—å–∫–æ –¥–ª—è PostgreSQL (SQLite –æ–≥—Ä–∞–Ω–∏—á–µ–Ω)
- –ù—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –∑–∞—Ä–∞–Ω–µ–µ

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–û—Å—Ç–∞–≤–∏—Ç—å `storage` –¥–ª—è –≥–∏–±–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö:

```sql
-- –ì–∏–±–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
CREATE TABLE storage (
    namespace TEXT NOT NULL,
    key TEXT NOT NULL,
    value TEXT NOT NULL,
    PRIMARY KEY (namespace, key)
);

-- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
CREATE TABLE devices (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE device_states (
    device_id TEXT PRIMARY KEY REFERENCES devices(id),
    desired JSONB NOT NULL,
    reported JSONB NOT NULL,
    pending BOOLEAN NOT NULL DEFAULT FALSE,
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE device_mappings (
    external_id TEXT PRIMARY KEY,
    internal_id TEXT NOT NULL REFERENCES devices(id),
    provider TEXT NOT NULL
);
```

**–ü–ª—é—Å—ã:**
- –ò–Ω–¥–µ–∫—Å—ã –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å JOIN'—ã

**–ú–∏–Ω—É—Å—ã:**
- –î–≤–∞ API (storage + –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- –°–ª–æ–∂–Ω–µ–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

### üéØ **–û—Å—Ç–∞–≤–∏—Ç—å –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É, –Ω–æ —É–ª—É—á—à–∏—Ç—å:**

1. **–î–ª—è PostgreSQL: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSONB –≤–º–µ—Å—Ç–æ TEXT**
   ```python
   # –í PostgreSQLAdapter
   value JSONB NOT NULL  -- –≤–º–µ—Å—Ç–æ TEXT
   ```
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è JSON
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤
   - –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ

2. **–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**
   ```sql
   -- –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
   CREATE INDEX idx_devices_state_pending 
   ON storage USING GIN ((value->'state'->>'pending'))
   WHERE namespace = 'devices';
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ JSON (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
   ```python
   # –í StorageAdapter (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   async def query(
       self, 
       namespace: str, 
       json_path: str, 
       value: Any
   ) -> list[dict]:
       """–ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏ –ø–æ JSON path (—Ç–æ–ª—å–∫–æ PostgreSQL)"""
   ```

### –ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é?

**–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å, –∫–æ–≥–¥–∞:**
- –ü–æ—è–≤–ª—è—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "–Ω–∞–π—Ç–∏ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å X"
- –û–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö >50K –∑–∞–ø–∏—Å–µ–π –≤ `devices`
- –ù—É–∂–Ω—ã JOIN'—ã –º–µ–∂–¥—É namespaces
- –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–µ–π—á–∞—Å:**
- –¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å JSONB –¥–ª—è PostgreSQL –∫–∞–∫ —É–ª—É—á—à–µ–Ω–∏–µ

## –í—ã–≤–æ–¥

### üéØ **Namespace pattern ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞!**

**–¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ (namespace –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ) –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- ‚úÖ –ü—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±—ã—Å—Ç—Ä–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ú–∞–ª—ã—Ö/—Å—Ä–µ–¥–Ω–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö (<100K –∑–∞–ø–∏—Å–µ–π –Ω–∞ namespace)
- ‚úÖ –ü—Ä–æ—Å—Ç—ã—Ö key-value –æ–ø–µ—Ä–∞—Ü–∏–π (–≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω)
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (—Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤ —Ä–∞–∑–Ω—ã—Ö namespaces)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç—ã –∫–æ–¥–∞ (–æ–¥–∏–Ω API –¥–ª—è –≤—Å–µ–≥–æ)
- ‚úÖ –õ–µ–≥–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

**–≠—Ç–æ –ù–ï "–º–µ—à–∞–Ω–∏–Ω–∞" ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω!**

### –ö–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é?

**–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏:**
- –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É JSON (>1000 –∑–∞–ø–∏—Å–µ–π)
- JOIN'—ã –º–µ–∂–¥—É namespaces (—Ä–µ–¥–∫–æ –Ω—É–∂–Ω–æ)
- –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö (>100K –∑–∞–ø–∏—Å–µ–π)
- –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ JSON

**–î–ª—è –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª—É—á–∞—è:**
- Namespace pattern –∏–¥–µ–∞–ª–µ–Ω ‚úÖ
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –≤–∞–∂–Ω–µ–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ
- –ì–∏–±–∫–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î ‚úÖ

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–û—Å—Ç–∞–≤–∏—Ç—å namespace pattern, –Ω–æ —É–ª—É—á—à–∏—Ç—å –¥–ª—è PostgreSQL:**
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **JSONB –≤–º–µ—Å—Ç–æ TEXT** –≤ PostgreSQL (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è + –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤)
2. –î–æ–±–∞–≤–∏—Ç—å **–∏–Ω–¥–µ–∫—Å—ã –ø–æ namespace** (—É–∂–µ –µ—Å—Ç—å —á–µ—Ä–µ–∑ PRIMARY KEY)
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏—Ç—å **GIN –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ JSONB** –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É

**–ò—Ç–æ–≥:** –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ ‚Äî —ç—Ç–æ –Ω–µ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å, –∞ **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä** –¥–ª—è key-value —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å –ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏–∑–æ–ª—è—Ü–∏–µ–π —á–µ—Ä–µ–∑ namespace!
