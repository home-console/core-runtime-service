# üîí Legacy –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—ë–Ω. DevicesPlugin ‚Äî –°–¢–†–û–ì–ê–Ø –º–æ–¥–µ–ª—å

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. –£–¥–∞–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ legacy-—Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚ùå –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è `power`, `on`, flat-state
- ‚ùå –£–¥–∞–ª–µ–Ω—ã –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –ø—É—Å—Ç–æ—Ç—ã
- ‚úÖ –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: `{desired, reported, pending}`

### 2. –í–≤–µ–¥–µ–Ω–∞ –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ `set_state`
- –ï—Å–ª–∏ device –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Üí `ValueError`
- –ï—Å–ª–∏ –ø–æ–ª—è –∏–º–µ—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã ‚Üí `ValueError`
- –ù–µ—Ç –º–æ–ª—á–∞–ª–∏–≤–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

**–ö–æ–¥:**
```python
# –ë–´–õ–û: –º–æ–ª—á–∞–ª–∏–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
if not isinstance(current_state, dict):
    current_state = {"desired": {}, "reported": {}, "pending": False}

# –°–¢–ê–õ–û: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
if not isinstance(current_state, dict) or \
   not all(k in current_state for k in ["desired", "reported", "pending"]):
    raise ValueError("Device has invalid state format...")
```

### 3. –í–≤–µ–¥–µ–Ω–∞ –ª–æ–≥–∏—Ä—É—é—â–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ `_handle_external_state`
- –ï—Å–ª–∏ device –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Üí –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
- –ù–µ –ø–∞–¥–∞–µ–º, –Ω–æ —è–≤–Ω–æ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ –ø—Ä–æ–±–ª–µ–º–µ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å –≤ –ª–æ–≥–∞—Ö –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

**–ö–æ–¥:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç, –ª–æ–≥–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
if not isinstance(old_state, dict) or \
   not all(k in old_state for k in ["desired", "reported", "pending"]):
    # –õ–æ–≥–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è
    await self.runtime.service_registry.call(
        "logger.log",
        level="warning",
        message=f"Invalid device state format: {internal_id}",
        ...
    )
    return
```

### 4. –£–ø—Ä–æ—â–µ–Ω–∞ `on_start`
- ‚ùå –£–¥–∞–ª–µ–Ω–∞ 50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è

**–ë—ã–ª–æ:**
```python
async def on_start(self) -> None:
    # 50 —Å—Ç—Ä–æ–∫: –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –º–∏–≥—Ä–∞—Ü–∏—è legacy —Å–æ—Å—Ç–æ—è–Ω–∏–π
    for dev_id in keys:
        device = await self.runtime.storage.get("devices", dev_id)
        state_value = device.get("state")
        if not isinstance(state_value, dict) or \
           not all(k in state_value for k in ["desired", "reported", "pending"]):
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –≤ –Ω–æ–≤—ã–π
            ...
```

**–°—Ç–∞–ª–æ:**
```python
async def on_start(self) -> None:
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è."""
    await super().on_start()
    
    # –¢–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
    self._external_state_handler = self._handle_external_state
    try:
        self.runtime.event_bus.subscribe(
            "external.device_state_reported",
            self._external_state_handler
        )
    except Exception:
        pass
    ...
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | Œî |
|---------|-----|-------|-----|
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | 542 | 538 | -0.7% |
| –õ–æ–≥–∏–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ | 50 —Å—Ç—Ä–æ–∫ | 0 | **-100%** |
| Legacy-–ø—Ä–æ–≤–µ—Ä–æ–∫ | 10+ | 1* | **-90%** |
| –¢–µ—Å—Ç—ã | 20/20 ‚úÖ | 20/20 ‚úÖ | ‚úÖ |

*–æ—Å—Ç–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ `_handle_external_state` –¥–ª—è graceful degradation —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –º–æ–¥–µ–ª—å (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è)

```
‚îå‚îÄ STRICT VALIDATION ‚îÄ‚îê
‚îÇ                     ‚îÇ
‚îÇ create_device()     ‚îÇ ‚Üí {desired, reported, pending}
‚îÇ                     ‚îÇ
‚îÇ set_state()         ‚îÇ ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç, –∏–Ω–∞—á–µ throws
‚îÇ                     ‚îÇ
‚îÇ _handle_external    ‚îÇ ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç, –∏–Ω–∞—á–µ logs
‚îÇ   _state()          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚úÖ No automatic recovery
‚úÖ No silent fixes
‚úÖ Fail fast or log explicitly
‚úÖ One true format forever
```

---

## üöÄ –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç

1. **–î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è**
   - –ï—Å–ª–∏ device —Å `power` –ø–æ–ø–∞–¥—ë—Ç ‚Üí –æ—à–∏–±–∫–∞
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

2. **–û—à–∏–±–∫–∏ –≤–∏–¥–Ω—ã —Å—Ä–∞–∑—É**
   - –ù–µ—Ç —Å–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º
   - –ù–µ—Ç –º–æ–ª—á–∞–ª–∏–≤—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π
   - –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã

3. **–ú–æ–¥–µ–ª—å –Ω–µ–∏–∑–º–µ–Ω–Ω–∞**
   - `{desired, reported, pending}` ‚Äî –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ
   - –ù–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–∏—à—É—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
   - –°—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏ –Ω–µ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è

4. **–ì–æ—Ç–æ–≤–æ –∫ production**
   - –°—Ç—Ä–æ–≥–æ –ø–æ –∞–∫—Å–∏–æ–º–∞–º
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ (20/20 pass)
   - –≠—Ç–∞–ª–æ–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–ª–∞–≥–∏–Ω–æ–≤

---

## ‚ú® –ò–¥–µ–æ–ª–æ–≥–∏—è

–≠—Ç–æ—Ç –ø–ª–∞–≥–∏–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø **"fail fast"**:
- ‚ùå –ù–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚ùå –ù–µ –º–æ–ª—á–∏–º –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚úÖ –õ–∏–±–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –õ–∏–±–æ –≤–∏–¥–Ω–∞ –æ—à–∏–±–∫–∞/–ª–æ–≥

–î–ª—è MVP –∏ production-—Å–∏—Å—Ç–µ–º —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä.

