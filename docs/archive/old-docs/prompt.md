# üîß Refactor Prompt ‚Äî devices_plugin (–≠—Ç–∞–ª–æ–Ω)

## üéØ –¶–µ–ª—å

–ü—Ä–∏–≤–µ—Å—Ç–∏ `devices_plugin.py` –≤ **—á–∏—Å—Ç–æ–µ, —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∏ —ç—Ç–∞–ª–æ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**,  
—É–±—Ä–∞–≤ legacy-–ª–æ–≥–∏–∫—É –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–≤ **–µ–¥–∏–Ω—É—é, –æ–±—ä—è—Å–Ω–∏–º—É—é –º–æ–¥–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤**.

–≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç** –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –ø–ª–∞–≥–∏–Ω–∞ `devices`.

---

## üìå –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≥—Ä–∞–Ω–∏—Ü—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

- `devices_plugin` ‚Äî **–¥–æ–º–µ–Ω–Ω—ã–π –ø–ª–∞–≥–∏–Ω**
- –û–Ω –æ—Ç–≤–µ—á–∞–µ—Ç **–¢–û–õ–¨–ö–û** –∑–∞:
  - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  - –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  - –¥–æ–º–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

### –ü–ª–∞–≥–∏–Ω –ù–ï –¥–æ–ª–∂–µ–Ω:
- –∑–Ω–∞—Ç—å –ø—Ä–æ –ë–î –∏–ª–∏ –∞–¥–∞–ø—Ç–µ—Ä—ã
- –∑–Ω–∞—Ç—å –ø—Ä–æ UI / admin
- –Ω–∞–ø—Ä—è–º—É—é —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ API (Yandex –∏ –¥—Ä.)
- –∏–º–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Core ‚Äî –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑:
- `runtime.storage`
- `runtime.state_engine`
- `runtime.event_bus`
- `runtime.service_registry`

---

## üß± –ï–¥–∏–Ω–∞—è –º–æ–¥–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç `device["state"]`:

```python
state = {
  "desired": dict,   # –∂–µ–ª–∞–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—á—Ç–æ —Ö–æ—Ç–∏–º)
  "reported": dict,  # –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—á—Ç–æ –≤–µ—Ä–Ω—É–ª –ø—Ä–æ–≤–∞–π–¥–µ—Ä)
  "pending": bool    # –æ–∂–∏–¥–∞–µ—Ç—Å—è –ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
}

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ
	‚Ä¢	state["on"]
	‚Ä¢	state["power"]
	‚Ä¢	—á–∞—Å—Ç–∏—á–Ω—ã–µ –∏–ª–∏ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
	‚Ä¢	–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–µ–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è desired / reported

‚∏ª

‚ùå –ß—Ç–æ –Ω—É–∂–Ω–æ –£–î–ê–õ–ò–¢–¨ –ø–æ–ª–Ω–æ—Å—Ç—å—é

Legacy-–º–µ—Ç–æ–¥—ã
	‚Ä¢	turn_on
	‚Ä¢	turn_off
	‚Ä¢	_change_state

Legacy-—Å–µ—Ä–≤–∏—Å—ã
	‚Ä¢	devices.turn_on
	‚Ä¢	devices.turn_off

Legacy-—Å–æ–±—ã—Ç–∏—è
	‚Ä¢	devices.state_changed

–õ—é–±—É—é –ª–æ–≥–∏–∫—É, –≥–¥–µ:
	‚Ä¢	—Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
	‚Ä¢	—Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è –Ω–µ —á–µ—Ä–µ–∑ devices.set_state
	‚Ä¢	–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è power, on, off –Ω–∞–ø—Ä—è–º—É—é

‚∏ª

‚úÖ –ß—Ç–æ –î–û–õ–ñ–ù–û –æ—Å—Ç–∞—Ç—å—Å—è

1Ô∏è‚É£ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–°–µ—Ä–≤–∏—Å:
devices.set_state(device_id: str, state: dict)

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:
	1.	–ü—Ä–æ—á–∏—Ç–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑ storage
	2.	–û–±–Ω–æ–≤–∏—Ç—å state.desired
	3.	–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å state.pending = True
	4.	–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±—Ä–∞—Ç–Ω–æ –≤ storage
	5.	–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ:
internal.device_command_requested

‚ö†Ô∏è reported –∑–¥–µ—Å—å –ù–ï –º–µ–Ω—è–µ—Ç—Å—è

‚∏ª

2Ô∏è‚É£ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–ß–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ:
external.device_state_reported

Handler –æ–±—è–∑–∞–Ω:
	1.	–ù–∞–π—Ç–∏ internal_id —á–µ—Ä–µ–∑ mapping
	2.	–ü—Ä–æ—á–∏—Ç–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–∑ storage
	3.	–û–±–Ω–æ–≤–∏—Ç—å state.reported
	4.	–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å state.pending = False
	5.	–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ storage
	6.	–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ:
internal.device_state_updated

3Ô∏è‚É£ on_start

–†–∞–∑—Ä–µ—à–µ–Ω–æ –¢–û–õ–¨–ö–û:
	‚Ä¢	–º–∏–≥—Ä–∞—Ü–∏—è legacy-—Å–æ—Å—Ç–æ—è–Ω–∏–π ‚Üí {desired, reported, pending}
	‚Ä¢	–∑–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–∑ storage
	‚Ä¢	–≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ read-model –≤ state_engine

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ:
	‚Ä¢	–æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥
	‚Ä¢	–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
	‚Ä¢	–ª—é–±—ã–µ side-effects

‚∏ª

üóÉÔ∏è –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
	‚Ä¢	‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî storage["devices"]
	‚Ä¢	state_engine:
	‚Ä¢	read-model
	‚Ä¢	–∫–µ—à
	‚Ä¢	–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø
	‚Ä¢	‚ùå –Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

‚∏ª

üö´ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
	‚Ä¢	–º–µ–Ω—è—Ç—å Core
	‚Ä¢	–º–µ–Ω—è—Ç—å admin_plugin
	‚Ä¢	–º–µ–Ω—è—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å–æ–±—ã—Ç–∏–π
	‚Ä¢	–¥–æ–±–∞–≤–ª—è—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ API

‚∏ª

‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
	‚Ä¢	devices_plugin.py:
	‚Ä¢	–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π
	‚Ä¢	—á–∏—Ç–∞–µ–º—ã–π
	‚Ä¢	–±–µ–∑ —Å–∫—Ä—ã—Ç–æ–π –º–∞–≥–∏–∏
	‚Ä¢	–ª—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
	‚Ä¢	–∏–¥—ë—Ç –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ devices.set_state
	‚Ä¢	–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
	‚Ä¢	–æ–±—ä—è—Å–Ω–∏–º–∞ —Å–ª–æ–≤–∞–º–∏
	‚Ä¢	–±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π
	‚Ä¢	–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏—Å—Ç–∏–Ω—ã

‚ö†Ô∏è –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏–µ ‚Äî —É–ø—Ä–æ—â–∞–π
–õ—É—á—à–µ –º–µ–Ω—å—à–µ –ª–æ–≥–∏–∫–∏, —á–µ–º –Ω–µ—è–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞.


