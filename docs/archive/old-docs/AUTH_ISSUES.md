# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (1.1, 1.2, 1.3)

- Password Authentication —Å bcrypt
- Session Management —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- API Key Management —Å —Ä–æ—Ç–∞—Ü–∏–µ–π

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ mapping –¥–ª—è –Ω–æ–≤—ã—Ö endpoints**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–æ–≤—ã–µ endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è–º–∏ –∏ —Å–µ—Å—Å–∏—è–º–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `ACTION_SCOPE_MAP`, –ø–æ—ç—Ç–æ–º—É –æ–Ω–∏ —Ç—Ä–µ–±—É—é—Ç `admin.*` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—á–µ—Ä–µ–∑ `action.startswith("admin.")`).

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ endpoints:**
- `admin.auth.set_password`
- `admin.auth.change_password`
- `admin.auth.list_sessions`
- `admin.auth.revoke_session`
- `admin.auth.revoke_all_sessions`
- `admin.auth.revoke_api_key`
- `admin.auth.rotate_api_key`

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ `ACTION_SCOPE_MAP` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ scopes.

---

### 2. **`admin.auth.login` —Ç—Ä–µ–±—É–µ—Ç admin –ø—Ä–∞–≤**

**–ü—Ä–æ–±–ª–µ–º–∞:** `admin.auth.login` —Ç—Ä–µ–±—É–µ—Ç `admin.*`, –Ω–æ –ª–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–∏–ª–∏ –≤–æ–æ–±—â–µ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É).

**–†–µ—à–µ–Ω–∏–µ:** –°–¥–µ–ª–∞—Ç—å `admin.auth.login` –ø—É–±–ª–∏—á–Ω—ã–º (–∫–∞–∫ `oauth_yandex.*`) –∏–ª–∏ —É–±—Ä–∞—Ç—å –∏–∑ `ACTION_SCOPE_MAP` –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.

---

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ownership**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å–∞–º–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- `admin.auth.change_password` - –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `admin.auth.revoke_all_sessions` - –º–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `admin.auth.set_password` - –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ü—Ä–∏–º–µ—Ä –∞—Ç–∞–∫–∏:**
```python
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å user1 —Å –ø—Ä–∞–≤–∞–º–∏ admin.auth.* –º–æ–∂–µ—Ç:
POST /admin/v1/auth/password/change
{"user_id": "user2", "old_password": "...", "new_password": "hacked"}
```

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É ownership –≤ `authz.check()` —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `resource`:
- –ï—Å–ª–∏ `user_id` –≤ resource —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `context.user_id` ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
- –ï—Å–ª–∏ `context.is_admin=True` ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
- –ò–Ω–∞—á–µ ‚Üí –∑–∞–ø—Ä–µ—â–µ–Ω–æ

---

## üü° –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 4. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å—Ç—å –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø–æ—Ö–æ–∂–µ–π –ª–æ–≥–∏–∫–æ–π:
- `check_service_scope()` –≤ `auth.py` (—Å—Ç—Ä–æ–∫–∞ 541)
- `check()` –≤ `authz.py` (—Å—Ç—Ä–æ–∫–∞ 73)

–û–Ω–∏ –¥–µ–ª–∞—é—Ç –ø–æ—Ö–æ–∂–∏–µ –≤–µ—â–∏, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É. `check_service_scope()` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ (—Ç–æ–ª—å–∫–æ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö).

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å `check_service_scope()` –∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É.

---

### 5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ expires_at –¥–ª—è API keys**

**–ü—Ä–æ–±–ª–µ–º–∞:** `validate_api_key()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `expires_at`, –Ω–æ —ç—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ. –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

---

### 6. **–ù–µ—Ç granular permissions –¥–ª—è auth –æ–ø–µ—Ä–∞—Ü–∏–π**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ auth –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç `admin.*`, –Ω–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Ä–∞–∑–¥–µ–ª–∏—Ç—å:
- `admin.auth.read` - –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–æ–≤ (list_api_keys, list_users, list_sessions)
- `admin.auth.write` - —Å–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ (create_api_key, create_user, set_password)
- `admin.auth.manage` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (revoke_session –¥–ª—è –¥—Ä—É–≥–∏—Ö, change_password –¥–ª—è –¥—Ä—É–≥–∏—Ö)

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ granular scopes –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É ownership.

---

## üü¢ –£–ª—É—á—à–µ–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### 7. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –¥–ª—è auth endpoints**

**–ü—Ä–æ–±–ª–µ–º–∞:** Rate limiting –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ middleware, –Ω–æ –Ω–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Ç–∏–ø–∞ `change_password` –∏–ª–∏ `revoke_all_sessions`.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

---

### 8. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ self-service**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –±–µ–∑ admin –ø—Ä–∞–≤:
- –ù–µ –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Å–µ—Å—Å–∏–∏
- –ù–µ –º–æ–∂–µ—Ç –æ—Ç–æ–∑–≤–∞—Ç—å —Å–≤–æ—é —Å–µ—Å—Å–∏—é
- –ù–µ –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø–∞—Ä–æ–ª—å (—Ç—Ä–µ–±—É–µ—Ç admin –ø—Ä–∞–≤)

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å self-service endpoints –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É ownership.

---

### 9. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ audit logging –¥–ª—è authz –ø—Ä–æ–≤–µ—Ä–æ–∫**

**–ü—Ä–æ–±–ª–µ–º–∞:** `authz.check()` –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–∫–∞–∑—ã –≤ –¥–æ—Å—Ç—É–ø–µ, —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `audit_log_auth_event()`.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–µ—Ç –±—ã—Ç—å —à—É–º–Ω–æ).

---

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å mapping –¥–ª—è –Ω–æ–≤—ã—Ö endpoints
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `admin.auth.login` (—Å–¥–µ–ª–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º)
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É ownership –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):
4. –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â—É—é –ª–æ–≥–∏–∫—É `check_service_scope()`
5. –î–æ–±–∞–≤–∏—Ç—å self-service endpoints

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–ª—É—á—à–µ–Ω–∏—è):
6. –î–æ–±–∞–≤–∏—Ç—å granular permissions
7. –£–ª—É—á—à–∏—Ç—å rate limiting
8. –î–æ–±–∞–≤–∏—Ç—å audit logging –¥–ª—è –æ—Ç–∫–∞–∑–æ–≤

---

## üîß –ë—ã—Å—Ç—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å mapping –¥–ª—è –Ω–æ–≤—ã—Ö endpoints

```python
# –í modules/api/authz.py, ACTION_SCOPE_MAP:
"admin.auth.set_password": "admin.*",  # –∏–ª–∏ "admin.auth.write"
"admin.auth.change_password": "admin.*",  # –∏–ª–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π ownership
"admin.auth.list_sessions": "admin.*",  # –∏–ª–∏ "admin.auth.read"
"admin.auth.revoke_session": "admin.*",  # –∏–ª–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π ownership
"admin.auth.revoke_all_sessions": "admin.*",  # –∏–ª–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π ownership
"admin.auth.revoke_api_key": "admin.*",
"admin.auth.rotate_api_key": "admin.*",
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –°–¥–µ–ª–∞—Ç—å login –ø—É–±–ª–∏—á–Ω—ã–º

```python
# –í modules/api/authz.py, check():
# –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π: login –ø—É–±–ª–∏—á–Ω—ã–π
if action == "admin.auth.login":
    return True  # –†–∞–∑—Ä–µ—à–∞–µ–º –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É ownership

```python
# –í modules/api/authz.py, check():
# –ü—Ä–æ–≤–µ—Ä–∫–∞ ownership –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
if action in ["admin.auth.change_password", "admin.auth.set_password", 
              "admin.auth.revoke_all_sessions"]:
    if resource and "user_id" in resource:
        target_user_id = resource["user_id"]
        # –†–∞–∑—Ä–µ—à–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ admin
        if ctx and (ctx.user_id == target_user_id or ctx.is_admin):
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É scopes
            pass
        else:
            return False  # –ó–∞–ø—Ä–µ—â–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á—É–∂–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
```
